# Federated Authentication Plugin

The Federated Authentication Plugin adds support for authentication via Federated Identity and then database access via IAM. 
Currently, only Microsoft Active Directory Federation Services (AD FS) is supported.

## What is Federated Identity
Federated Identity allows users to use the same set of credentials to access multiple services or resources across different organizations. 
This works by having a single Identity Provider (IdP), and multiple Service Providers (SP) having trust relationships with the IdP.   
The IdP manages and authenticates user credentials. 
The SPs are services or resources that can be internal or external, belonging to various organizations.

## Prerequisites
> :warning: **Note:** To preserve compatibility with customers using the community driver, This plugin requires the [AWS Java SDK RDS v2.7.x](https://central.sonatype.com/artifact/software.amazon.awssdk/rds) and the [AWS Java SDK STS v2.7.x](https://central.sonatype.com/artifact/software.amazon.awssdk/sts) to be included separately in the classpath. The AWS Java SDK RDS and AWS Java SDK STS are runtime dependencies and must be resolved.

## How to use Federation with the AWS JDBC Driver 

1. Enable AWS IAM database authentication on an existing database or create a new database with AWS IAM database authentication on the AWS RDS Console:
    1. If needed, review the documentation about [creating a new database](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_CreateDBInstance.html).
    2. If needed, review the documentation about [modifying an existing database](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Overview.DBInstance.Modifying.html).
2. Set up an [AWS IAM policy](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html) for AWS IAM database authentication.
3. [Create a database account](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.DBAccounts.html) using AWS IAM database authentication. This will be the user specified in the connection string or connection properties.
   1. Connect to your database of choice using primary logins.
      1. For a MySQL database, use the following command to create a new user:<br>
      `CREATE USER example_user_name IDENTIFIED WITH AWSAuthenticationPlugin AS 'RDS';`
      2. For a PostgreSQL database, use the following command to create a new user:<br>
      `CREATE USER db_userx;
      GRANT rds_iam TO db_userx;`
4. Set up your IAM Identity Provider and IAM role. The IAM role should be using the IAM policy set up in step 2. 
   1. If needed, review the documentation about [creating IAM identity providers](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create.html). For AD FS, see the documention about [creating IAM SAML identity providers](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_saml.html).
5. Add the plugin code `federatedAuth` to the [`wrapperPlugins`](../UsingTheJdbcDriver.md#connection-plugin-manager-parameters) value, or to the current [driver profile](../UsingTheJdbcDriver.md#connection-plugin-manager-parameters).
6. Specify the following parameters that are required or specific to your case:

| Parameter                  |  Value  | Required | Description                                                                                                                                                                                                                                                                                                                                                        | Default Value                            | Example Value                                          |
|----------------------------|:-------:|:--------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|--------------------------------------------------------|
| `dbUser`                   | String  |   Yes    | The user name of the IAM user with access to your database. <br>If you have previously used the IAM Authentication Plugin, this would be the same IAM user. <br>For information on how to connect to your Aurora Database with IAM, see this [documentation](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/UsingWithRDS.IAMDBAuth.Connecting.html). | `null`                                   | `some_user_name`                                       |
| `idpUsername`              | String  |   Yes    | The user name for the `idpEndpoint` server. If this parameter is not specified, the plugin will fallback to using the `user` parameter.                                                                                                                                                                                                                            | `null`                                   | `jimbob@example.com`                                   |
| `idpPassword`              | String  |   Yes    | The password associated with the `idpEndpoint` username. If this parameter is not specified, the plugin will fallback to using the `password` parameter.                                                                                                                                                                                                           | `null`                                   | `someRandomPassword`                                   |
| `idpEndpoint`              | String  |   Yes    | The hosting URL for the service that you are using to authenticate into AWS Aurora.                                                                                                                                                                                                                                                                                | `null`                                   | `ec2amaz-ab3cdef.example.com`                          |
| `iamRoleArn`               | String  |   Yes    | The ARN of the IAM Role that is to be assumed to access AWS Aurora.                                                                                                                                                                                                                                                                                                | `null`                                   | `arn:aws:iam::123456789012:role/adfs_example_iam_role` |
| `iamIdpArn`                | String  |   Yes    | The ARN of the Identity Provider.                                                                                                                                                                                                                                                                                                                                  | `null`                                   | `arn:aws:iam::123456789012:saml-provider/adfs_example` |
| `iamRegion`                | String  |   Yes    | The IAM region where the IAM token is generated.                                                                                                                                                                                                                                                                                                                   | `null`                                   | `us-east-2`                                            |
| `idpName`                  | String  |    No    | The name of the Identity Provider implementation used.                                                                                                                                                                                                                                                                                                             | `adfs`                                   | `adfs`                                                  |
| `idpPort`                  | String  |    No    | The port that the host for the authentication service listens at.                                                                                                                                                                                                                                                                                                  | `443`                                    | `1234`                                                 |
| `rpIdentifier`             | String  |    No    | The relaying party identifier.                                                                                                                                                                                                                                                                                                                                     | `urn:amazon:webservices`                 | `urn:amazon:webservices`                               |
| `iamHost`                  | String  |    No    | Overrides the host that is used to generate the IAM token.                                                                                                                                                                                                                                                                                                         | `null`                                   | `database.cluster-hash.us-east-1.rds.amazonaws.com`    |
| `iamDefaultPort`           | String  |    No    | This property overrides the default port that is used to generate the IAM token. The default port is determined based on the underlying driver protocol. For now, there is support for `jdbc:postgresql:` and `jdbc:mysql:`. Target drivers with different protocols will require users to provide a default port.                                                 | `null`                                   | `1234`                                                 |
| `iamTokenExpiration`       | Integer |    No    | Overrides the default IAM token cache expiration in seconds                                                                                                                                                                                                                                                                                                        | `930`                                    | `123`                                                  |
| `httpClientSocketTimeout`  | Integer |    No    | The socket timeout value in milliseconds for the HttpClient used by the FederatedAuthenticationPlugin.                                                                                                                                                                                                                                                             | `60000`                                  | `60000`                                                |
| `httpClientConnectTimeout` | Integer |    No    | The connect timeout value in milliseconds for the HttpClient used by the FederatedAuthenticationPlugin.                                                                                                                                                                                                                                                            | `60000`                                  | `60000`                                                |
| `sslInsecure`              | Boolean |    No    | Indicates whether or not the SSL connection is secure or not. If not, it will allow SSL connections to be made without validating the server's certificates.                                                                                                                                                                                                       | `true`                                   | `false`                                                |

## Sample code
[FederatedAuthPluginExample.java](../../../examples/AWSDriverExample/src/main/java/software/amazon/FederatedAuthPluginExample.java)
